worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout 65;

		access_log /var/log/nginx/access.log;
		error_log /var/log/nginx/error.log warn;

		proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=60m use_temp_path=off;

		# Limit requests
		limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";

    # Gzip Compression
    gzip on;
    gzip_disable "msie6";
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Default proxy settings
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_connect_timeout       10;
    proxy_send_timeout          60;
    proxy_read_timeout          60;
    send_timeout                60;

    #upstream admin_service {
        #server admin_service:8001;
    #}

    upstream asset_service {
        server asset_service:8002;
    }

    upstream auth_service {
			server auth_service:8020;
    }

    upstream industry_context_service {
        server industry_context_service:8004;
    }

    upstream llm_orchestration_service {
        server llm_orchestration_service:8000;
    }

    #upstream metadata_service {
        #server metadata_service:8006;
    #}

    upstream profile_generation_service {
        server profile_generation_service:8007;
    }

    upstream profile_management_service {
        server profile_management_service:8003;
    }

    #upstream search_service {
        #server search_service:8009;
    #}

    #upstream translation_service {
        #server translation_service:8010;
    #}

    #upstream user_management_service {
        #server user_management_service:8011;
    #}

    server {
        listen 80;

				# Security headers
				add_header X-Frame-Options "SAMEORIGIN" always;
				add_header X-Content-Type-Options "nosniff" always;
				add_header X-XSS-Protection "1; mode=block" always;
				add_header Referrer-Policy "no-referrer-when-downgrade" always;
				add_header Permissions-Policy "geolocation=(), microphone=()" always;
				add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        #location /admin/ {
            #proxy_pass http://admin_service/;
        #}

        location /asset/ {
            proxy_pass http://asset_service/;
        }

				location /auth/ {
						# Limit requests
						limit_req zone=api_limit burst=20 nodelay;

						# Timeouts
						proxy_pass http://auth_service/;
						proxy_connect_timeout 5s;
						proxy_send_timeout 10s;
						proxy_read_timeout 10s;

						# Cache responses
						proxy_cache api_cache;
						proxy_cache_valid 200 302 10m;
						proxy_cache_valid 404 1m;
				}

        location /industry-context/ {
						# Limit requests
						limit_req zone=api_limit burst=20 nodelay;

						# Timeouts
            proxy_pass http://industry_context_service/;
						proxy_connect_timeout 5s;
						proxy_send_timeout 10s;
						proxy_read_timeout 10s;

						# Cache responses
						proxy_cache api_cache;
						proxy_cache_valid 200 302 10m;
						proxy_cache_valid 404 1m;
        }

        location /llm/ {
            proxy_pass http://llm_orchestration_service/;
        }

        #location /metadata/ {
            #proxy_pass http://metadata_service/;
        #}

        location /profile-gen/ {
            proxy_pass http://profile_generation_service/;
        }

        location /profile-manage/ {
            proxy_pass http://profile_management_service/;
        }

        #location /search/ {
            #proxy_pass http://search_service/;
        #}

        #location /translate/ {
            #proxy_pass http://translation_service/;
        #}

        #location /user/ {
            #proxy_pass http://user_management_service/;
        #}

        # Catch-all fallback for unknown routes
        location / {
            return 404;
        }
    }
}
